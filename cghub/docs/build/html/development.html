

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Development &mdash; CGHub Browser 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="CGHub Browser 0.1 documentation" href="index.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Welcome to CGHub Browser’s documentation!" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="testing.html" title="Testing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to CGHub Browser’s documentation!"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">CGHub Browser 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="development">
<h1>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h1>
<div class="section" id="setting-up-and-running-the-app">
<h2>Setting up and running the app<a class="headerlink" href="#setting-up-and-running-the-app" title="Permalink to this headline">¶</a></h2>
<p>Make sure RabbitMQ server is installed (see section about RabbitMQ below).</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># pay attention to comments</span>

git clone git@github.com:dudarev/cghub.git cghub
<span class="nb">cd </span>cghub
cp Makefile.def.default Makefile.def
cp cghub/settings/local.py.default cghub/settings/local.py
mkdir <span class="o">{</span>pids,logs<span class="o">}</span>

<span class="c"># either</span>
mkvirtualenv -r requirements.txt cghub
<span class="c"># or (if not using virtualenvwrapper)</span>
pip install -r requirements

make syncdb
make celeryd

<span class="c"># in another terminal from `cghub` directory</span>
make run
</pre></div>
</div>
</div>
<div class="section" id="filters-customizing">
<h2>Filters customizing<a class="headerlink" href="#filters-customizing" title="Permalink to this headline">¶</a></h2>
<p>Filters list can be edited in <tt class="docutils literal"><span class="pre">cghub/apps/core/filters_storage_full.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ALL_FILTERS</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
<span class="p">(</span><span class="s">&quot;study&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;By Study&quot;</span><span class="p">,</span>
    <span class="s">&quot;filters&quot;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">([</span>
        <span class="p">(</span><span class="s">&quot;phs000178&quot;</span><span class="p">,</span> <span class="s">&quot;TCGA&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;TCGA_MUT_BENCHMARK_4&#39;</span><span class="p">,</span> <span class="s">&#39;TCGA Benchmark&#39;</span><span class="p">),</span>
    <span class="p">])</span>
<span class="p">}),</span>
<span class="p">(</span><span class="s">&quot;center_name&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;By Center&quot;</span><span class="p">,</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>In case of refassem_short_name, complex queries with &#8220;OR&#8221; are allowed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="s">&#39;refassem_short_name&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s">&#39;filters&#39;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">([</span>
        <span class="p">(</span><span class="s">&#39;NBCI36* OR HG18*&#39;</span><span class="p">,</span> <span class="s">&#39;NBCI36/HG18&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;GRCh37* OR HG19*&#39;</span><span class="p">,</span> <span class="s">&#39;GRCh37/HG19&#39;</span><span class="p">),</span>
    <span class="p">]),</span>
    <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">&#39;By Assembly&#39;</span><span class="p">,</span>
<span class="p">}),</span>
</pre></div>
</div>
</div>
<div class="section" id="filters-list-shortening">
<h2>Filters list shortening<a class="headerlink" href="#filters-list-shortening" title="Permalink to this headline">¶</a></h2>
<p>There are many possible options for filters in the sidebar. Not all of them are used by CGHub. To reduce the list a management command <tt class="docutils literal"><span class="pre">selectfilters</span></tt> is written. It should be used as following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python manage.py selectfilters
</pre></div>
</div>
<p>It takes file <tt class="docutils literal"><span class="pre">cghub/apps/core/filters_storage_full.py</span></tt> and for every filter stored there checks if results with such filter may be obtained for the API. First it queries for today, then last 7 days and keeps increasing time interval until results are found. If the results are found the filter is copied into <tt class="docutils literal"><span class="pre">cghub/apps/core/filters_storage.json</span></tt>, otherwise it is ignored. Also the filters that are already queried are placed into a temporary file <tt class="docutils literal"><span class="pre">is_filter_used.pkl</span></tt>, so that the command may be interrupted and started again.</p>
<p>If it is necessary to erase information about filters that were ran use <tt class="docutils literal"><span class="pre">-c</span></tt> option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python manage.py selectfilters -c
</pre></div>
</div>
<p>Filters list can be accessed from <tt class="docutils literal"><span class="pre">filters_storage.py</span></tt>, where automatically creates ALL_TILTERS variable and populates by data stored in <tt class="docutils literal"><span class="pre">filters_storage.json</span></tt>. If <tt class="docutils literal"><span class="pre">filters_storage.json</span></tt> will be missed, then <tt class="docutils literal"><span class="pre">filters_storage.json.default</span></tt> will be used instead.</p>
</div>
<div class="section" id="celery">
<h2>Celery<a class="headerlink" href="#celery" title="Permalink to this headline">¶</a></h2>
<p>We use Celery for periodic tasks (only caching for now).</p>
<p><a class="reference external" href="http://www.celeryproject.org/">Celery</a> - distributed task queue.</p>
<p>From celery documentatin:
The execution units, called tasks, are executed concurrently on a single or more worker servers using multiprocessing, Eventlet, or gevent. Tasks can execute asynchronously (in the background) or synchronously (wait until ready).</p>
<p>Celery requires a solution to send and receive messages, usually this comes in the form of a separate service called a message broker. The most popular is <a class="reference external" href="http://www.rabbitmq.com/">RabbitMQ</a>.</p>
<p>We use <a class="reference external" href="https://github.com/celery/django-celery">djcelery</a> for integratin celery to django. It provides using the Django ORM and cache backend for storing results, autodiscovery of task modules for applications listed in INSTALLED_APPS, and more.</p>
</div>
<div class="section" id="rabbitmq">
<h2>RabbitMQ<a class="headerlink" href="#rabbitmq" title="Permalink to this headline">¶</a></h2>
<p>As message broker for Celery we use RabbitMQ.</p>
<div class="section" id="installing-from-the-apt-repository-for-debian-ubuntu">
<h3>Installing from the APT repository for Debian/Ubuntu<a class="headerlink" href="#installing-from-the-apt-repository-for-debian-ubuntu" title="Permalink to this headline">¶</a></h3>
<p>As described in <a class="reference external" href="http://www.rabbitmq.com/install-debian.html">RabbitMQ docs</a>:</p>
<p>Add the following line to your <tt class="docutils literal"><span class="pre">/etc/apt/sources.list</span></tt>: <tt class="docutils literal"><span class="pre">deb</span> <span class="pre">http://www.rabbitmq.com/debian/</span> <span class="pre">testing</span> <span class="pre">main</span></tt></p>
<p>(Please note that the word testing in this line refers to the state of our release of RabbitMQ, not any particular Debian distribution. You can use it with Debian stable, testing or unstable, as well as with Ubuntu. We describe the release as &#8220;testing&#8221; to emphasise that we release somewhat frequently.)</p>
<p>(optional) To avoid warnings about unsigned packages, add our public key to your trusted key list using apt-key(8):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>wget http://www.rabbitmq.com/rabbitmq-signing-key-public.asc
<span class="nv">$ </span>sudo apt-key add rabbitmq-signing-key-public.asc
</pre></div>
</div>
<p>Run</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo apt-get update
</pre></div>
</div>
<p>Install packages as usual; for instance,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo apt-get install rabbitmq-server
</pre></div>
</div>
</div>
<div class="section" id="setting-up-rabbitmq">
<h3>Setting up RabbitMQ<a class="headerlink" href="#setting-up-rabbitmq" title="Permalink to this headline">¶</a></h3>
<p>To use Celery we need to create a RabbitMQ user, a virtual host and
allow that user access to that virtual host:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rabbitmqctl add_user myuser mypassword
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rabbitmqctl add_vhost myvhost
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rabbitmqctl set_permissions -p myvhost myuser <span class="s2">&quot;.*&quot;</span> <span class="s2">&quot;.*&quot;</span> <span class="s2">&quot;.*&quot;</span>
</pre></div>
</div>
<p>See the RabbitMQ <a class="reference external" href="http://www.rabbitmq.com/admin-guide.html">Admin Guide</a> for more information about <a class="reference external" href="http://www.rabbitmq.com/admin-guide.html#access-control">access control</a>.</p>
</div>
</div>
<div class="section" id="daemonizing-celery">
<h2>Daemonizing Celery<a class="headerlink" href="#daemonizing-celery" title="Permalink to this headline">¶</a></h2>
<p>If you want to daemonize celery, you may use scripts provided by celery itself.
Installation:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>wget https://raw.github.com/celery/celery/master/extra/generic-init.d/celeryd https://raw.github.com/celery/celery/master/extra/generic-init.d/celerybeat https://raw.github.com/celery/celery/master/extra/generic-init.d/celeryevcam
<span class="nv">$ </span>chmod 755 celeryd celerybeat celeryevcam
<span class="nv">$ </span>sudo mv celeryd /etc/init.d/celeryd
<span class="nv">$ </span>sudo mv celerybeat /etc/init.d/celerybeat
<span class="nv">$ </span>sudo mv celeryevcam /etc/init.d/celeryevcam
<span class="nv">$ </span>sudo touch /etc/default/celeryd
<span class="nv">$ </span>sudo vim /etc/default/celeryd
</pre></div>
</div>
<p>Change to your paths:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># /etc/default/celeryd</span>

<span class="c"># Name of nodes to start, here we have a single node</span>
<span class="nv">CELERYD_NODES</span><span class="o">=</span><span class="s2">&quot;w1&quot;</span>
<span class="c"># or we could have three nodes:</span>
<span class="c">#CELERYD_NODES=&quot;w1 w2 w3&quot;</span>

<span class="c"># Where to chdir at start. Location of manage.py</span>
<span class="nv">CELERYD_CHDIR</span><span class="o">=</span><span class="s2">&quot;/path/to/project&quot;</span>

<span class="c"># Python interpreter from virtual environment.</span>
<span class="nv">ENV_PYTHON</span><span class="o">=</span><span class="s2">&quot;path/to/env/bin/python&quot;</span>

<span class="c"># How to call &quot;manage.py celeryd_multi&quot;</span>
<span class="nv">CELERYD_MULTI</span><span class="o">=</span><span class="s2">&quot;$ENV_PYTHON $CELERYD_CHDIR/manage.py celeryd_multi&quot;</span>

<span class="c"># How to call &quot;manage.py celeryctl&quot;</span>
<span class="nv">CELERYCTL</span><span class="o">=</span><span class="s2">&quot;$ENV_PYTHON $CELERYD_CHDIR/manage.py celeryctl&quot;</span>

<span class="c"># Extra arguments to celeryd</span>
<span class="nv">CELERYD_OPTS</span><span class="o">=</span><span class="s2">&quot;-E --time-limit=300 --concurrency=8&quot;</span>

<span class="c"># Name of the celery config module.</span>
<span class="nv">CELERY_CONFIG_MODULE</span><span class="o">=</span><span class="s2">&quot;cghub.settings&quot;</span>

<span class="c"># %n will be replaced with the nodename.</span>
<span class="nv">CELERYD_LOG_FILE</span><span class="o">=</span><span class="s2">&quot;/path/to/logs/dir/%n.log&quot;</span>
<span class="nv">CELERYD_PID_FILE</span><span class="o">=</span><span class="s2">&quot;/path/to/pids/dir/%n.pid&quot;</span>

<span class="c"># Workers should run as an unprivileged user.</span>
<span class="nv">CELERYD_USER</span><span class="o">=</span><span class="s2">&quot;celery&quot;</span>
<span class="nv">CELERYD_GROUP</span><span class="o">=</span><span class="s2">&quot;celery&quot;</span>

<span class="c"># Name of the projects settings module.</span>
<span class="nb">export </span><span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span><span class="s2">&quot;cghub.settings&quot;</span>

<span class="c"># Where the Django project is.</span>
<span class="nv">CELERYBEAT_CHDIR</span><span class="o">=</span><span class="s2">&quot;/path/to/project&quot;</span>

<span class="c"># Path to celerybeat</span>
<span class="nv">CELERYBEAT</span><span class="o">=</span><span class="s2">&quot;$ENV_PYTHON $CELERYD_CHDIR/manage.py celerybeat&quot;</span>

<span class="c"># Extra arguments to celerybeat</span>
<span class="nv">CELERYBEAT_OPTS</span><span class="o">=</span><span class="s2">&quot;--schedule=/var/run/celerybeat-schedule&quot;</span>

<span class="nv">CELERYBEAT_PID_FILE</span><span class="o">=</span><span class="s2">&quot;/path/to/logs/dir/celerybeat.pid&quot;</span>
<span class="nv">CELERYBEAT_LOG_FILE</span><span class="o">=</span><span class="s2">&quot;/path/to/logs/dir/celerybeat.log&quot;</span>

<span class="c"># Path to celeryd</span>
<span class="nv">CELERYEV</span><span class="o">=</span><span class="s2">&quot;$ENV_PYTHON $CELERYD_CHDIR/manage.py&quot;</span>

<span class="c"># Extra arguments to manage.py</span>
<span class="nv">CELERYEV_OPTS</span><span class="o">=</span><span class="s2">&quot;celeryev&quot;</span>

<span class="c"># Camera class to use (required)</span>
<span class="nv">CELERYEV_CAM</span><span class="o">=</span><span class="s2">&quot;djcelery.snapshot.Camera&quot;</span>

<span class="nv">CELERYEV_PID_FILE</span><span class="o">=</span><span class="s2">&quot;/path/to/pids/dir/celeryevcam.pid&quot;</span>
<span class="nv">CELERYEV_LOG_FILE</span><span class="o">=</span><span class="s2">&quot;/path/to/logs/dir/celeryevcam.log&quot;</span>
</pre></div>
</div>
<p>Note that if you want Django to monitor tasks (in the admin panel or at the status page provided by the cghub app) you need to start celeryd with &#8220;-E&#8221; argument to create events and start /etc/init.d/celeryevcam daemon.</p>
<p>Also if you choose to run as unprivileged user <tt class="docutils literal"><span class="pre">celery</span></tt>, make sure to create it and change permissions of all required directories</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo adduser --system --no-create-home --disabled-login --disabled-password --group celery
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>sudo chown celery:celery /var/run/celery/
sudo chown celery:celery /tmp/wsapi/
</pre></div>
</div>
<p>Start daemons:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo /etc/init.d/celeryd start
<span class="nv">$ </span>sudo /etc/init.d/celerybeat start
<span class="nv">$ </span>sudo /etc/init.d/celeryevcam start
</pre></div>
</div>
<p>Make sure that logs are OK (if you set up <tt class="docutils literal"><span class="pre">/path/to/logs/dir</span></tt> above as <tt class="docutils literal"><span class="pre">/var/log/celery</span></tt>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>vim /var/log/celery/w1.log
<span class="nv">$ </span>vim /var/log/celery/celerybeat.log
<span class="nv">$ </span>vim /var/log/celery/celeryevcam.log
</pre></div>
</div>
<p>or just</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>vim /var/log/celery/*.log
</pre></div>
</div>
<p>On the website check <tt class="docutils literal"><span class="pre">/admin/djcelery/workerstate/</span></tt> and <tt class="docutils literal"><span class="pre">/admin/djcelery/periodictask/</span></tt> to see that the worker is online and periodic task are scheduled (you need to see at least two, one for cleaning requests cache, another for cleaning cart cache). You may adjust periodicity there as well.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Development</a><ul>
<li><a class="reference internal" href="#setting-up-and-running-the-app">Setting up and running the app</a></li>
<li><a class="reference internal" href="#filters-customizing">Filters customizing</a></li>
<li><a class="reference internal" href="#filters-list-shortening">Filters list shortening</a></li>
<li><a class="reference internal" href="#celery">Celery</a></li>
<li><a class="reference internal" href="#rabbitmq">RabbitMQ</a><ul>
<li><a class="reference internal" href="#installing-from-the-apt-repository-for-debian-ubuntu">Installing from the APT repository for Debian/Ubuntu</a></li>
<li><a class="reference internal" href="#setting-up-rabbitmq">Setting up RabbitMQ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#daemonizing-celery">Daemonizing Celery</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Welcome to CGHub Browser&#8217;s documentation!</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="testing.html"
                        title="next chapter">Testing</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/development.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="testing.html" title="Testing"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to CGHub Browser’s documentation!"
             >previous</a> |</li>
        <li><a href="index.html">CGHub Browser 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, CGHub UCSC.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>